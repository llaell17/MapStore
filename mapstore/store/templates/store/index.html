<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Map Store — Produtos</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 30px auto; }
    label { display:inline-block; width:80px; }
    input { margin-bottom:8px; }
    table { width:100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align:left; }
    .msg { margin-top:10px; }
  </style>
</head>
<body>
  <h1>Map Store — Produtos</h1>
  <p>Crie e liste produtos. Regras: preço ≥ 1; estoque ≥ 0.</p>

  <section id="form">
    <h2>Adicionar Produto</h2>
    <div class="msg" id="msg"></div>
    <form id="productForm">
      <div><label>Nome:</label><input id="nome" required /></div>
      <div><label>Preço:</label><input id="preco" type="number" step="0.01" required /></div>
      <div><label>Estoque:</label><input id="estoque" type="number" required /></div>
      <button type="submit">Salvar</button>
    </form>
  </section>

  <hr />

  <section id="list">
    <h2>Lista de Produtos</h2>
    <div id="listMsg"></div>
    <table id="prodTable">
      <thead><tr><th>#</th><th>Nome</th><th>Preço</th><th>Estoque</th><th>Ações</th></tr></thead>
      <tbody id="prodBody"><tr><td colspan="5">Carregando...</td></tr></tbody>
    </table>
  </section>

<script>
const API_BASE = '/api';

async function fetchProdutos() {
  const res = await fetch(API_BASE + '/produtos/');
  return res.json();
}

async function createProduto(prod) {
  const res = await fetch(API_BASE + '/produtos/', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(prod)
  });
  const json = await res.json();
  if (!res.ok) throw json;
  return json;
}

async function deleteProduto(id) {
  const res = await fetch(API_BASE + '/produtos/' + id + '/', { method: 'DELETE' });
  return res.json();
}

function showMsg(elId, text, ok=true) {
  const el = document.getElementById(elId);
  el.innerHTML = `<div style="color:${ok?'green':'red'}">${text}</div>`;
  setTimeout(()=>el.innerHTML='', 4000);
}

async function load() {
  const tbody = document.getElementById('prodBody');
  tbody.innerHTML = '<tr><td colspan="5">Carregando...</td></tr>';
  try {
    const data = await fetchProdutos();
    if (!Array.isArray(data) || data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5">Nenhum produto</td></tr>';
      return;
    }
    tbody.innerHTML = data.map(p => `
      <tr>
        <td>${p.id}</td>
        <td>${p.nome}</td>
        <td>R$ ${Number(p.preco).toFixed(2)}</td>
        <td>${p.estoque}</td>
        <td><button onclick="onDelete(${p.id})">Excluir</button></td>
      </tr>
    `).join('');
  } catch (err) {
    tbody.innerHTML = '<tr><td colspan="5">Erro ao carregar produtos</td></tr>';
  }
}

async function onDelete(id) {
  if (!confirm('Deletar este produto?')) return;
  try {
    await deleteProduto(id);
    showMsg('listMsg', 'Produto deletado', true);
    load();
  } catch (err) {
    showMsg('listMsg', 'Erro ao deletar', false);
  }
}

document.getElementById('productForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const nome = document.getElementById('nome').value.trim();
  const preco = parseFloat(document.getElementById('preco').value);
  const estoque = parseInt(document.getElementById('estoque').value, 10);

  try {
    await createProduto({ nome, preco, estoque });
    showMsg('msg', 'Produto criado com sucesso!', true);
    document.getElementById('productForm').reset();
    load();
  } catch (err) {
    const text = err && err.preco ? err.preco : (err && err.estoque ? err.estoque : (err && err.detail ? JSON.stringify(err.detail) : (err && err.errors ? err.errors.join('; ') : 'Erro')));
    showMsg('msg', text || 'Erro ao criar produto', false);
  }
});

window.addEventListener('load', load);
</script>
</body>
</html>
